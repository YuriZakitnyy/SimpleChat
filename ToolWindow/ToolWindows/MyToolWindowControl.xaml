<UserControl x:Class="ToolWindow.MyToolWindowControl"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:imaging="clr-namespace:Microsoft.VisualStudio.Imaging;assembly=Microsoft.VisualStudio.Imaging"
             xmlns:theming="clr-namespace:Microsoft.VisualStudio.PlatformUI;assembly=Microsoft.VisualStudio.Imaging"
             xmlns:util="clr-namespace:Microsoft.VisualStudio.PlatformUI;assembly=Microsoft.VisualStudio.Utilities"
             xmlns:catalog="clr-namespace:Microsoft.VisualStudio.Imaging;assembly=Microsoft.VisualStudio.ImageCatalog"
             xmlns:toolkit="clr-namespace:Community.VisualStudio.Toolkit;assembly=Community.VisualStudio.Toolkit"
             mc:Ignorable="d"
             d:DesignHeight="300" d:DesignWidth="300"
             Name="MyToolWindow" MouseMove="MyToolWindow_MouseMove" KeyDown="MyToolWindow_KeyDown">
    <UserControl.Resources>
        <BooleanToVisibilityConverter x:Key="BTV"/>
        
        <!-- Container style controls alignment and spacing for each message item -->
        <Style x:Key="ChatItemContainerStyle" TargetType="ListBoxItem">
            <Setter Property="Padding" Value="2"/>
            <Setter Property="Margin" Value="4"/>
            <Setter Property="HorizontalContentAlignment" Value="Left"/>
            <Setter Property="VerticalContentAlignment" Value="Top"/>
            <Style.Triggers>
                <!-- Align sent messages to the right -->
                <DataTrigger Binding="{Binding IsSent}" Value="True">
                    <Setter Property="HorizontalContentAlignment" Value="Right"/>
                </DataTrigger>
            </Style.Triggers>
        </Style>
        
        <DataTemplate x:Key="ChatMessageDataTemplate">
            <Border x:Name="Bubble"
                    Padding="8"
                    CornerRadius="8"
                    Background="#F0F0F0"
                    MaxWidth="520"
                    SnapsToDevicePixels="True">
                <StackPanel>
                    <TextBlock Text="{Binding UserName}" FontWeight="SemiBold" FontSize="12" Margin="0,0,0,4"/>
                    <TextBox Text="{Binding MessageText}"  BorderThickness="0" Background="Transparent" IsReadOnly="True" TextWrapping="Wrap" Visibility="{Binding IsText, Converter={StaticResource BTV}, FallbackValue=Visible}" />
                    <Image Source="{Binding Image}" Stretch="Uniform" MaxWidth="400" MaxHeight="300" Visibility="{Binding IsImage, Converter={StaticResource BTV}, FallbackValue=Visible}">
                        <Image.InputBindings>
                            <!-- Binds the LeftClick action to a command in the DataContext -->
                            <MouseBinding 
                                Command="{Binding ClickCommand}" 
                                MouseAction="LeftClick" />
                        </Image.InputBindings>
                    </Image>
                    <TextBlock Text="{Binding FileName}" Foreground="Blue" TextWrapping="Wrap" Visibility="{Binding IsFile, Converter={StaticResource BTV}, FallbackValue=Visible}">
                        <TextBlock.InputBindings>
                            <!-- Binds the LeftClick action to a command in the DataContext -->
                            <MouseBinding 
                                Command="{Binding ClickCommand}" 
                                MouseAction="LeftClick" />
                        </TextBlock.InputBindings>
                    </TextBlock>
                    <TextBlock Text="{Binding Time, StringFormat='{}{0:HH:mm}'}"
                               FontSize="10"
                               Foreground="Gray"
                               HorizontalAlignment="Right"
                               Margin="0,6,0,0"/>
                </StackPanel>
            </Border>

            <DataTemplate.Triggers>
                <!-- Sent messages: blue bubble and right alignment -->
                <DataTrigger Binding="{Binding IsSent}" Value="True">
                    <Setter TargetName="Bubble" Property="Background" Value="#D0E8FF"/>
                    <Setter TargetName="Bubble" Property="HorizontalAlignment" Value="Right"/>
                </DataTrigger>

                <!-- Received messages: light gray bubble and left alignment -->
                <DataTrigger Binding="{Binding IsReceived}" Value="True">
                    <Setter TargetName="Bubble" Property="Background" Value="#F0F0F0"/>
                    <Setter TargetName="Bubble" Property="HorizontalAlignment" Value="Left"/>
                </DataTrigger>
            </DataTemplate.Triggers>
        </DataTemplate>
    </UserControl.Resources>
    
    <Grid Margin="5">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>
        
        <Expander Header="Connection Settings" IsExpanded="True" Margin="5,0,0,5">
            <StackPanel Grid.Row="0" Orientation="Vertical" HorizontalAlignment="Left" Margin="0">
                <ComboBox ItemsSource="{Binding Addresses}" SelectedItem="{Binding BackendUrl, Mode=TwoWay}"
                  Width="240" HorizontalAlignment="Left" IsEditable="True" IsTextSearchEnabled="True"/>
                <TextBox Text="{Binding UserName,Mode=TwoWay}" HorizontalAlignment="Left" Margin="0, 5" Width="240" VerticalContentAlignment="Center" />
                <StackPanel Orientation="Horizontal" Margin="0,0,0,0">
                    <Button DataContext="{Binding ConnectCommand}" Command="{Binding}" Content="{Binding Header}" Height="25" IsEnabled="{Binding Enabled}" Width="115" Margin="0,0,10,0" />
                    <Button DataContext="{Binding DisconnectCommand}" Command="{Binding}" Content="{Binding Header}"  Height="25"  IsEnabled="{Binding Enabled}" Width="115"/>
                </StackPanel>
            </StackPanel>
        </Expander>

        <Grid Grid.Row="1" Visibility="{Binding ShowMessages, Converter={StaticResource BTV}, FallbackValue=Collapsed}">
            <Grid.RowDefinitions>
                <RowDefinition Height="*" />
                <RowDefinition Height="Auto" />
            </Grid.RowDefinitions>
            <ListBox x:Name="MessagesListBox" Grid.Row="0" ItemsSource="{Binding Path=Messages}" Margin="0,0,0,0"
                ItemTemplate="{StaticResource ChatMessageDataTemplate}"
                ItemContainerStyle="{StaticResource ChatItemContainerStyle}"
                ScrollViewer.CanContentScroll="True"
                VirtualizingStackPanel.IsVirtualizing="True"
                VirtualizingStackPanel.VirtualizationMode="Recycling"
                VirtualizingStackPanel.ScrollUnit="Pixel"/>
            <Grid Grid.Row="1" Margin="0,0,0,0" Height="60">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>
                <TextBox Text="{Binding MessageText,Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" Margin="0,0,0,0"
                    VerticalContentAlignment="Top"
                    AcceptsReturn="True"
                    TextWrapping="Wrap"
                    VerticalScrollBarVisibility="Auto"
                    HorizontalScrollBarVisibility="Disabled"
                    AllowDrop="True" 
                    PreviewDragOver="FilePathTextBox_PreviewDragOver" 
                    Drop="FilePathTextBox_Drop">
                    <TextBox.InputBindings>
                        <KeyBinding Key="Enter" Modifiers="Control" Command="{Binding SendCommand}"/>
                        <KeyBinding Key="G"  Modifiers="Control" Command="{Binding SwitchMode}"/>
                    </TextBox.InputBindings>
                </TextBox>
                <Button Grid.Column="1" DataContext="{Binding SendCommand}" Command="{Binding}" Content="{Binding Header}" IsEnabled="{Binding Enabled}" Width="80" />
            </Grid>
        </Grid>
        
        <Grid Grid.Row="1"  Visibility="{Binding ShowText, Converter={StaticResource BTV}, FallbackValue=Collapsed}">
            <Grid.RowDefinitions>
                <RowDefinition Height="*" />
                <RowDefinition Height="Auto" />
            </Grid.RowDefinitions>

            <TextBox x:Name="MessagesTextBox" Margin="0,0,0,0" VerticalContentAlignment="Top"
                AcceptsReturn="True" TextWrapping="Wrap" VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled"
                AllowDrop="True" 
                PreviewDragOver="FilePathTextBox_PreviewDragOver" 
                Drop="FilePathTextBox_Drop">
                <TextBox.InputBindings>
                    <KeyBinding Key="G"  Modifiers="Control" Command="{Binding SwitchMode}"/>
                </TextBox.InputBindings>
            </TextBox>

            <TextBox Grid.Row="1" Text="{Binding MessageText,Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                Margin="0,0,0,0"
                Height="60"
                VerticalContentAlignment="Top"
                AcceptsReturn="True"
                TextWrapping="Wrap"
                VerticalScrollBarVisibility="Auto"
                HorizontalScrollBarVisibility="Disabled"
                AllowDrop="True" 
                PreviewDragOver="FilePathTextBox_PreviewDragOver" 
                Drop="FilePathTextBox_Drop">
                <TextBox.InputBindings>
                    <KeyBinding Key="Enter" Modifiers="Control" Command="{Binding SendCommand}"/>
                    <KeyBinding Key="G"  Modifiers="Control" Command="{Binding SwitchMode}"/>
                    <KeyBinding Key="M"  Modifiers="Control+Shift" Command="{Binding ShowMessagesCommand}"/>
                </TextBox.InputBindings>
                <TextBox.CommandBindings>
                    <CommandBinding Command="ApplicationCommands.Paste"
                                    Executed="MessageTextBox_PasteExecuted"
                                    CanExecute="MessageTextBox_PasteCanExecute"/>
                </TextBox.CommandBindings>
            </TextBox>
        </Grid>

        <Grid Grid.Row="1" Visibility="{Binding ShowComments, Converter={StaticResource BTV}, FallbackValue=Visible}">
            <Grid.RowDefinitions>
                <RowDefinition Height="*" />
                <RowDefinition Height="Auto" />
            </Grid.RowDefinitions>
            <TextBox Grid.Row="0" Text="{Binding Comments,Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                VerticalContentAlignment="Top"
                AcceptsReturn="True"
                TextWrapping="Wrap"
                VerticalScrollBarVisibility="Auto"
                HorizontalScrollBarVisibility="Disabled">
                <TextBox.InputBindings>
                    <KeyBinding Key="G"  Modifiers="Control" Command="{Binding SwitchMode}"/>
                    <KeyBinding Key="M"  Modifiers="Control+Shift" Command="{Binding ShowMessagesCommand}"/>
                </TextBox.InputBindings>
            </TextBox>
            <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="0,0,0,0">
                <Button DataContext="{Binding SaveComments}" Command="{Binding}" Content="{Binding Header}" Height="25" IsEnabled="{Binding Enabled}" Width="115" Margin="5" />
                <Button DataContext="{Binding LoadComments}" Command="{Binding}" Content="{Binding Header}" Height="25" IsEnabled="{Binding Enabled}" Width="115" Margin="5"/>
            </StackPanel>
        </Grid>
    </Grid>
</UserControl>
